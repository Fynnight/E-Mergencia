<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-mergencia - {% block title %}{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    {% load static %}
    <link href="{% static 'css/style.css' %}" rel="stylesheet">
</head>
<body>
    <style>
        /* Estilos del dropdown menu personalizados */
        .dropdown-menu {
            padding: 1rem;
            min-width: 250px;
        }
        .dropdown-menu .welcome-text {
            font-size: 1.1rem;
            color: #0284c7;
            font-weight: 500;
            text-align: center;
            margin-bottom: 0.5rem;
        }
        .dropdown-menu .user-name {
            font-size: 0.9rem;
            color: #6c757d;
            text-align: center;
            margin-bottom: 1rem;
        }
        .dropdown-menu .dropdown-item {
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            margin-bottom: 0.25rem;
        }
        .dropdown-menu .dropdown-item:hover {
            background-color: #eff6ff;
            color: #0284c7;
        }
        .dropdown-menu .dropdown-item.disabled {
            color: #6c757d;
            background-color: transparent;
        }
        .dropdown-menu .dropdown-item i {
            margin-right: 0.5rem;
        }
        .dropdown-menu .dropdown-divider {
            margin: 0.5rem 0;
        }
        .footer {
            background-color: #f8f9fa;
            padding: 1rem 0;
            position: fixed;
            bottom: 0;
            width: 100%;
            border-top: 1px solid #e7e7e7;
        }
        .main-container {
            margin-bottom: 100px;
        }
        .disabled-link {
            color: #6c757d !important;
            pointer-events: none;
            text-decoration: none;
        }
    </style>
    
    <nav class="navbar navbar-expand-lg navbar-custom mb-4">
        <div class="container">
            <a class="navbar-brand" href="{% url 'index' %}">E-mergencia</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    {% if request.session.user_rut %}
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                                Mi Cuenta
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li>
                                    <div class="welcome-text">¡Bienvenido(a)!</div>
                                    <div class="user-name">{{ request.session.user_nombre }}</div>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                
                                {# Verificar rol del usuario - Especialista tiene prioridad #}
                                {% if user_role == 'especialista' or request.session.user_rol == 'especialista' %}
                                    <!-- Opciones para Especialista/Médico -->
                                    <li>
                                        <a class="dropdown-item" href="{% url 'listar_consultas_medico' %}">
                                            <i class="bi bi-calendar-check"></i> Listar Consultas
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="{% url 'listar_pacientes' %}">
                                            <i class="bi bi-people"></i> Listar Pacientes
                                        </a>
                                    </li>
                                {% elif user_role == 'paciente' or request.session.user_rol == 'paciente' %}
                                    <!-- Opciones para Paciente -->
                                    <li>
                                        <a class="dropdown-item" href="{% url 'agendar_nueva_cita' %}">
                                            <i class="bi bi-calendar-plus"></i> Agendar Nueva Cita
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="{% url 'consultar_citas' %}">
                                            <i class="bi bi-calendar-check"></i> Consultar mis Citas
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="{% url 'mis_documentos' %}">
                                            <i class="bi bi-file-earmark-text"></i> Mis Documentos
                                        </a>
                                    </li>
                                {% endif %}
                                
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <form action="{% url 'api_logout' %}" method="POST" class="m-0">
                                        {% csrf_token %}
                                        <button type="submit" class="dropdown-item text-danger">
                                            <i class="bi bi-box-arrow-right"></i> Cerrar Sesión
                                        </button>
                                    </form>
                                </li>
                            </ul>
                        </li>
                    {% else %}
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#loginModal">Iniciar Sesión</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#registerModal">Registrarse</a>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <div class="container main-container">
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}

        {% block content %}{% endblock %}
    </div>

    <footer class="footer">
        <div class="container text-center">
            <span>E-mergencia &copy; 2025 | </span>
            <a href="#" class="disabled-link">¿Quiénes somos?</a>
        </div>
    </footer>

    <!-- Modal de Login -->
    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Iniciar Sesión</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="loginRut" class="form-label">
                                RUT <small class="text-muted">(sin puntos y sin guión)</small>
                            </label>
                            <input type="text" class="form-control" id="loginRut" required 
                                   placeholder="Ejemplo: 123456789"
                                   maxlength="9"
                                   pattern="^[0-9]{8}[0-9kK]{1}$"
                                   title="Ingrese 9 caracteres (números o K) sin puntos ni guión">
                            <div class="invalid-feedback">
                                El RUT debe contener exactamente 9 caracteres, sin puntos ni guión
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="loginPassword" class="form-label">Contraseña</label>
                            <input type="password" class="form-control" id="loginPassword" required>
                        </div>
                        <div class="alert alert-danger d-none" id="loginError"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="handleLogin()">Iniciar Sesión</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Registro -->
    <div class="modal fade" id="registerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Registro de Usuario</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="registerForm" class="needs-validation" novalidate>
                        <div class="mb-3">
                            <label for="registerRut" class="form-label">
                                RUT <span class="text-danger">*</span> <small class="text-muted">(sin puntos y sin guión)</small>
                            </label>
                            <input type="text" class="form-control" id="registerRut" required
                                   placeholder="Ejemplo: 123456789"
                                   maxlength="9"
                                   pattern="^[0-9]{8}[0-9kK]{1}$"
                                   title="Ingrese 9 caracteres (números o K) sin puntos ni guión">
                            <div class="invalid-feedback">
                                El RUT debe contener exactamente 9 caracteres, sin puntos ni guión
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="registerNombre" class="form-label">
                                Nombre <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="registerNombre" required
                                   minlength="2" pattern="[A-Za-záéíóúÁÉÍÓÚñÑ\s]+"
                                   title="Ingrese un nombre válido">
                            <div class="invalid-feedback">
                                Ingrese un nombre válido
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="registerApellido" class="form-label">
                                Apellido <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="registerApellido" required
                                   minlength="2" pattern="[A-Za-záéíóúÁÉÍÓÚñÑ\s]+"
                                   title="Ingrese un apellido válido">
                            <div class="invalid-feedback">
                                Ingrese un apellido válido
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="registerEmail" class="form-label">
                                Correo Electrónico <span class="text-danger">*</span>
                            </label>
                            <input type="email" class="form-control" id="registerEmail" required
                                   pattern="[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$"
                                   title="Ingrese un correo electrónico válido">
                            <div class="invalid-feedback">
                                Ingrese un correo electrónico válido
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="registerPassword" class="form-label">
                                Contraseña <span class="text-danger">*</span>
                            </label>
                            <input type="password" class="form-control" id="registerPassword" required
                                   minlength="8"
                                   pattern="^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{8,}$"
                                   title="La contraseña debe tener al menos 8 caracteres, incluyendo al menos una letra y un número">
                            <div class="form-text">
                                La contraseña debe tener:
                                <ul class="mb-0">
                                    <li>Al menos 8 caracteres</li>
                                    <li>Al menos una letra</li>
                                    <li>Al menos un número</li>
                                </ul>
                            </div>
                            <div class="invalid-feedback">
                                La contraseña debe cumplir con los requisitos mencionados
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="registerFechaNacimiento" class="form-label">
                                Fecha de Nacimiento <span class="text-danger">*</span>
                            </label>
                            <input type="date" class="form-control" id="registerFechaNacimiento" required
                                   max="{{ now|date:'Y-m-d' }}">
                            <div class="invalid-feedback">
                                Ingrese una fecha de nacimiento válida
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="registerTelefono" class="form-label">
                                Teléfono <small class="text-muted">(opcional)</small>
                            </label>
                            <input type="tel" class="form-control" id="registerTelefono"
                                   pattern="[0-9]{9}"
                                   title="Ingrese un número de teléfono válido (9 dígitos)">
                            <div class="invalid-feedback">
                                Ingrese un número de teléfono válido (9 dígitos)
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="registerDireccion" class="form-label">
                                Dirección <small class="text-muted">(opcional)</small>
                            </label>
                            <input type="text" class="form-control" id="registerDireccion">
                        </div>
                        <div class="alert alert-danger d-none" id="registerError"></div>
                        <small class="text-muted d-block mb-3">Los campos marcados con <span class="text-danger">*</span> son obligatorios</small>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="handleRegister()">Registrarse</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
    // Función para validar RUT
    function validarRut(rut) {
        return /^[0-9]{8}[0-9kK]{1}$/.test(rut);
    }

    // Función para validar contraseña
    function validarPassword(password) {
        return /^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{8,}$/.test(password);
    }

    // Agregar validación en tiempo real para los campos
    document.addEventListener('DOMContentLoaded', function() {
        const rutInputs = document.querySelectorAll('#loginRut, #registerRut');
        const passwordInputs = document.querySelectorAll('#loginPassword, #registerPassword');

        rutInputs.forEach(input => {
            input.addEventListener('input', function() {
                if (validarRut(this.value)) {
                    this.classList.remove('is-invalid');
                    this.classList.add('is-valid');
                } else {
                    this.classList.remove('is-valid');
                    this.classList.add('is-invalid');
                }
            });
        });

        passwordInputs.forEach(input => {
            input.addEventListener('input', function() {
                if (validarPassword(this.value)) {
                    this.classList.remove('is-invalid');
                    this.classList.add('is-valid');
                } else {
                    this.classList.remove('is-valid');
                    this.classList.add('is-invalid');
                }
            });
        });
    });

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    async function handleLogin() {
        const loginError = document.getElementById('loginError');
        loginError.classList.add('d-none');

        const rutInput = document.getElementById('loginRut');
        const passwordInput = document.getElementById('loginPassword');
        const rut = rutInput.value;
        const password = passwordInput.value;

        // Validar RUT
        if (!validarRut(rut)) {
            loginError.textContent = 'El RUT debe tener 9 caracteres, sin puntos ni guión';
            loginError.classList.remove('d-none');
            rutInput.classList.add('is-invalid');
            return;
        }

        const data = { rut, contrasena: password };

        try {
            const response = await fetch('{% url "api_login" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                credentials: 'include',
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (response.ok) {
                window.location.reload();
            } else {
                loginError.textContent = result.error || 'Error al iniciar sesión';
                loginError.classList.remove('d-none');
            }
        } catch (error) {
            loginError.textContent = 'Error de conexión';
            loginError.classList.remove('d-none');
        }
    }

    async function handleRegister() {
        const registerError = document.getElementById('registerError');
        registerError.classList.add('d-none');

        const form = document.getElementById('registerForm');
        const allInputs = form.querySelectorAll('input');
        let isValid = true;
        let firstInvalidElement = null;

        // Restablecer validación
        allInputs.forEach(input => {
            input.classList.remove('is-invalid', 'is-valid');
        });

        // Validar campos requeridos y patrones
        allInputs.forEach(input => {
            if (input.required && !input.value) {
                input.classList.add('is-invalid');
                isValid = false;
                firstInvalidElement = firstInvalidElement || input;
                return;
            }

            if (input.pattern && input.value) {
                const regex = new RegExp(input.pattern);
                if (!regex.test(input.value)) {
                    input.classList.add('is-invalid');
                    isValid = false;
                    firstInvalidElement = firstInvalidElement || input;
                    return;
                }
            }

            // Validaciones específicas
            switch (input.id) {
                case 'registerRut':
                    if (!validarRut(input.value)) {
                        input.classList.add('is-invalid');
                        isValid = false;
                        firstInvalidElement = firstInvalidElement || input;
                    }
                    break;
                case 'registerPassword':
                    if (!validarPassword(input.value)) {
                        input.classList.add('is-invalid');
                        isValid = false;
                        firstInvalidElement = firstInvalidElement || input;
                    }
                    break;
                case 'registerFechaNacimiento':
                    const fechaNacimiento = new Date(input.value);
                    const hoy = new Date();
                    if (fechaNacimiento >= hoy) {
                        input.classList.add('is-invalid');
                        isValid = false;
                        firstInvalidElement = firstInvalidElement || input;
                    }
                    break;
                case 'registerEmail':
                    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(input.value)) {
                        input.classList.add('is-invalid');
                        isValid = false;
                        firstInvalidElement = firstInvalidElement || input;
                    }
                    break;
            }

            // Si el campo es válido y tiene valor, mostrar feedback positivo
            if (input.value && !input.classList.contains('is-invalid')) {
                input.classList.add('is-valid');
            }
        });

        if (!isValid) {
            registerError.textContent = 'Por favor, complete todos los campos obligatorios correctamente';
            registerError.classList.remove('d-none');
            firstInvalidElement.focus();
            return;
        }

        const data = {
            rut: document.getElementById('registerRut').value,
            nombre: document.getElementById('registerNombre').value,
            apellido: document.getElementById('registerApellido').value,
            correo: document.getElementById('registerEmail').value,
            contrasena: document.getElementById('registerPassword').value,
            fecha_nacimiento: document.getElementById('registerFechaNacimiento').value,
            telefono: document.getElementById('registerTelefono').value || null,
            direccion: document.getElementById('registerDireccion').value || null
        };

        try {
            const response = await fetch('{% url "api_registro" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (response.ok) {
                window.location.reload();
            } else {
                registerError.textContent = Object.values(result).flat().join(', ') || 'Error al registrarse';
                registerError.classList.remove('d-none');
            }
        } catch (error) {
            registerError.textContent = 'Error de conexión';
            registerError.classList.remove('d-none');
        }
    }
    </script>
</body>
</html>